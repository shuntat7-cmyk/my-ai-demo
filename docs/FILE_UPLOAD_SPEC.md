# 商談ダッシュボード：ファイルアップロード機能 技術要件

## 1. 商談で「刺さる」要件（機能イメージ）

| 用途 | 説明 | 例 |
|------|------|-----|
| **書類の種類** | 商談で使う書類を分類して管理 | 提案書・議事録・見積書・契約書・その他 |
| **クライアント紐づけ** | どの企業の商談用か分かる | アクティビティの「クライアント」と紐づけ |
| **アクティビティ連携** | どのアクションで使ったか | 「提案書送付」「見積もり提出」と紐づけ可能 |
| **一覧・検索** | すぐ取り出せる | 日付・クライアント・種類でフィルタ |
| **制限と安心感** | 形式・サイズ制限で信頼感 | PDF/DOCX/XLSX など、最大 10MB など |

---

## 2. 技術的に必要なもの

### 2.1 フロントエンド（このリポジトリで実装）

- **アップロードUI**
  - ドラッグ＆ドロップ or ファイル選択
  - 種類選択（提案書 / 議事録 / 見積書 / 契約書 / その他）
  - クライアント名 or アクティビティ選択（既存の「最新のアクティビティ」と連携すると刺さる）
  - アップロード進捗表示（任意）
- **一覧UI**
  - アップロード済みファイル一覧（名前・種類・クライアント・日付）
  - ダウンロード・削除
  - モバイルでも崩れないレイアウト（既存のレスポンシブ方針に合わせる）
- **技術**
  - `FormData` + `fetch` で API に POST
  - ファイル種別・サイズのクライアント側チェック（UX とエラー表示用）
  - 必要なら `react-dropzone` などのライブラリ（任意）

### 2.2 バックエンド（API）

- **ルート**
  - `POST /api/upload` … ファイル受信・保存・メタデータ返却
  - `GET /api/files` … 一覧取得（クライアント・種類・日付でフィルタ可能にすると商談で使いやすい）
  - `GET /api/files/[id]` または `GET /api/files/[id]/download` … ダウンロード
  - `DELETE /api/files/[id]` … 削除
- **実装**
  - Next.js App Router の **Route Handler**（`app/api/upload/route.ts` など）
  - `request.formData()` で `multipart/form-data` を受け取る
  - ボディサイズ制限: `next.config.ts` の `experimental.serverActions.bodySizeLimit` または API 用に別設定（後述）

### 2.3 ストレージ（ファイルの保存先）

| 方式 | 用途 | 必要なもの |
|------|------|------------|
| **ローカルディスク** | デモ・開発 | サーバー上のディレクトリ（例: `uploads/`）。Vercel はサーバーレスなので再デプロイで消える点に注意。 |
| **Vercel Blob** | デモ〜小規模本番 | `@vercel/blob`、`BLOB_READ_WRITE_TOKEN`。Vercel デプロイと相性が良い。 |
| **S3 / GCS / R2** | 本番向け | 各クラウドの SDK、バケット・認証情報。耐久性・コストを考慮。 |

**デモで刺さるなら**: まずは **Vercel Blob** がおすすめ（設定が少なく、デプロイ先と統一しやすい）。

### 2.4 メタデータの保存先

- **ファイル名・サイズ・MIME・種類（提案書など）・クライアント・作成日時** をどこかに持つ必要がある。
- **選択肢**
  - **JSON ファイル / メモリ**: デモ用。再起動で消える or ファイルに書き出す簡易実装。
  - **SQLite / Prisma + SQLite**: ローカルで完結、デモ〜小規模に適する。
  - **Vercel KV / Upstash Redis**: キー・値で一覧・フィルタを簡易に。
  - **PostgreSQL（Vercel Postgres 等）**: 本番でリレーションや検索をしっかりやりたい場合。

**デモで刺さるなら**: まずは **JSON ファイル** や **Vercel Blob のメタデータ** だけで一覧を返し、必要になったら DB を導入する形が現実的。

---

## 3. セキュリティ・制限

- **許可する MIME タイプ**: `application/pdf`, `application/vnd.openxmlformats-officedocument.*` (DOCX/XLSX), `image/*` などに限定。
- **拡張子**: `.pdf`, `.docx`, `.xlsx`, `.png`, `.jpg`, `.jpeg` などホワイトリスト。
- **ファイルサイズ**: 例として 1 ファイル 10MB、1 リクエスト 20MB まで。
- **Next.js**: API の body サイズ制限を上げる（`next.config.ts` で `experimental.serverActions.bodySizeLimit` や API route 用の設定を確認）。
- **保存ファイル名**: 元のファイル名をそのまま使うと衝突・パストラバーサルになりやすいので、**UUID + 拡張子** などサーバー側で一意の名前にする。

---

## 4. 実装の進め方（おすすめ順）

1. **ストレージを決める**  
   - デモのみ → ローカル `uploads/` または Vercel Blob。
2. **POST /api/upload**  
   - `formData` 受信 → バリデーション → 保存 → メタデータを返す。
3. **メタデータの保持**  
   - 初回は配列をメモリ or JSON ファイルに保存し、一覧 API で返す。
4. **GET /api/files**  
   - 一覧返却（クライアント・種類・日付フィルタは後から追加可）。
5. **フロント**  
   - ダッシュボードに「書類アップロード」ブロックを追加 → 種類・クライアント選択 → アップロード → 一覧表示・ダウンロード。
6. **GET /api/files/[id]` と DELETE**  
   - ダウンロード・削除を有効化。
7. **アクティビティとの紐づけ**  
   - メタデータに `activityId` や `clientName` を持たせ、「最新のアクティビティ」と連携すると商談で刺さる。

---

## 5. このリポジトリで今すぐ必要な追加

- **パッケージ**  
  - ストレージに **Vercel Blob** を使う場合: `@vercel/blob`
- **設定**  
  - `next.config.ts`: API body サイズ制限（必要に応じて）。
  - 環境変数: `BLOB_READ_WRITE_TOKEN`（Vercel Blob の場合）。
- **新規ファイル例**
  - `app/api/upload/route.ts`
  - `app/api/files/route.ts`（一覧）
  - `app/api/files/[id]/route.ts`（取得・削除）
  - フロント: アップロード用コンポーネント + 一覧用コンポーネント（既存 `app/page.tsx` やプロジェクトページに配置）。

---

## 6. まとめ

| 項目 | 内容 |
|------|------|
| **フロント** | アップロードフォーム（種類・クライアント）＋ 一覧・ダウンロード・削除 UI |
| **API** | POST /upload, GET /files, GET /files/[id], DELETE /files/[id] |
| **ストレージ** | デモは Vercel Blob またはローカル、本番は S3/R2 等 |
| **メタデータ** | デモは JSON または Blob メタデータ、必要なら DB へ |
| **制限** | ファイル種別・サイズ・保存名のサーバー側チェック |

この方針で実装すれば、商談デモで「提案書・見積書をここにまとめて管理できる」と説明しやすい構成になります。
